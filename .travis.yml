sudo: false
dist: trusty

language: node_js
node_js:
  - "node"

cache:
  yarn: true
  directories:
    - node_modules

before_install:
  - curl -o- -L https://yarnpkg.com/install.sh | bash
  - export PATH="$HOME/.yarn/bin:$PATH"

before_script:
  - if [ -f $(git rev-parse --git-dir)/shallow ]; then git fetch --unshallow; fi
  - yarn

script:
  - yarn build
  - yarn build-zip
  - test -f dist/manifest.json
  - test -f dist/background.js
  - test -f dist/vendor.js
  - cmp src/icons/icon_48.png dist/icons/icon_48.png
  - cmp src/icons/icon_128.png dist/icons/icon_128.png
  - test -f "dist-zip/alderiate-live-v$(node -pe "require('./package.json').version").zip"

before_deploy:
  - export RELEASE_EXTENSION_FILE=$(ls dist-zip/*.zip)
  - echo "Deploying ${RELEASE_EXTENSION_FILE} to GitHub releases"

deploy:
  provider: releases
  api_key:
    secure: t6YLxjPC7mJsAsU8BfF616t+KmDffRI8dHubaUQcUE26pouTDVRZ/px4buyLjG96WDj5Z5JAvDiim2j7N+bUY2onR+SegdiibAz+O0Ti8TH3DRVRXnru3bfBig3dVVwwwpCnywlNxPjUO0OyreaHSNy6vT8wRpewtwh3gsWgu1mw1Tx2Yx2zeViHEo082gRiupYkK/d+KIgaBN11FO28MU0/eT2Sp7CGwm8Fb+EPGdH1t+mS8TAH59bm3V1lkY5/Rnb7YkITcGcGHoMxU7fp9z0AwqxxFo56nHi0nl1z0zEgq2Cv6Ohbrq/0TzrNaweu1LqbDGWjq0Ur1EUxwdizJ4rN/P/uxZsTkx1mehlkN7kwmS5JJzQv9ZlF5QO3mOOT6fzTRdyaOyCEUpTseYBvyug34PqKnsHxf1fCQytFu3U7LGGyU6+LRGN29cdnPmuBu04Es978fXp5VAANRAeHZR0S81DOKtNwRR3ecWzzW8AlGI0Dp5SyWMMw0B+mmqzD7CrDmmbtLb0MdUdN1MnxfslE+3JJtoOalTMs+8Xx1JzWK4AH6tr+0qa5IhRtIGenhbxlwlT+aAWVI8NT28Q1pc+MMleh1Tl8E2AaZrwCy1QOG7thNyFBH1wzosHb1K+nSGApHuPSzZKTMso9Uwqn+vihRs0soaJ0V8W3YQ/0TkI=
  file: "${RELEASE_EXTENSION_FILE}"
  skip_cleanup: true
  on:
    repo: Kocal/Alderiate-Live
    tags: true
